@use './core' as *;
@use './animations';
@use '../backdrop';
@use '../core/styles/theme';

$can-animate: '[open]:not([animation-type=none])';

@layer base, nonmodal, animation, placement, size-strategy, preset, fullscreen, position-strategy, media;

//
// Base
//

@layer base {
  //
  // Host styles
  //

  :host {
    @include host;

    @include theme.provide((
      surface: theme.variable(surface-bright)
    ));
  }

  :host([hidden]) {
    display: none;
  }

  //
  // Base
  //

  .forge-dialog {
    @include tokens;
  }

  .forge-dialog {
    @include dialog-base;
  }

  .container {
    @include container;
  }

  .surface {
    @include surface;
  }

  //
  // Backdrop
  //

  dialog.forge-dialog {
    &::backdrop {
      display: none; // Hide the native backdrop
    }
  }

  forge-backdrop {
    @include backdrop.provide-theme((
      opacity: #{token(backdrop-opacity)},
      enter-animation-duration: #{token(enter-animation-duration)},
      enter-animation-easing: #{token(enter-animation-easing)},
      exit-animation-duration: #{token(exit-animation-duration)},
      exit-animation-easing: #{token(exit-animation-easing)}
    ));
  }

  //
  // Moveable
  //
  
  :host(:not([moveable])) {
    .move-handle {
      display: none;
    }
  }

  :host([moveable]:not([fullscreen]):not([preset])) {
    .surface {
      user-select: none;
    }

    .surface.moved {
      margin: 0;
    }

    .move-handle {
      position: absolute;
      top: 0;
      z-index: 1;
      display: flex;
      justify-content: center;
      width: 100%;
  
      svg {
        fill: currentColor;
        height: 1.5rem;
        width: 1.5rem;
        margin-block-start: -4px;
        border-radius: 50%;
        touch-action: none;
  
        &:hover {
          cursor: grab;
        }
  
        &:active {
          cursor: grabbing;
        }
      }
    }
  }

  //
  // Open
  //

  :host([open]) {
    @include host-open;
  }
}

//
// Non-modal
//

@layer nonmodal {
  :host([mode=nonmodal]) {
    .forge-dialog {
      position: fixed;
      pointer-events: none;
    }

    .container {
      display: contents;
    }

    .surface {
      @include override(elevation, nonmodal-elevation);

      pointer-events: all;
    }

    forge-backdrop {
      display: none;
    }
  }
}

//
// Animation
//

@layer animation {
  :host(#{$can-animate}) {
    dialog.forge-dialog[open] {
      .surface {
        @include enter;

        &.exiting {
          @include exit;
        }
      }
    }
  }

  // Zoom (default)
  :host(#{$can-animate}:is(:not([animation-type]),[animation-type=zoom])) {
    dialog.forge-dialog[open] {
      .surface {
        animation-name: zoom-in;

        &.exiting {
          animation-name: zoom-out;
        }
      }
    }
  }

  // Fade
  :host(#{$can-animate}[animation-type=fade]) {
    dialog.forge-dialog[open] {
      .surface {
        animation-name: fade-in;

        &.exiting {
          animation-name: fade-out;
        }
      }
    }
  }

  // Slide
  :host(#{$can-animate}[animation-type=slide]) {
    dialog.forge-dialog[open] {
      .surface {
        animation-name: slide-in;

        &.exiting {
          animation-name: slide-out;
        }
      }
    }
  }
}

//
// Placement
//

@layer placement {
  :host([placement=custom]) {
    .surface {
      @include override(spacing, 0, value);

      top: var(--forge-dialog-position-x, 0);
      left: var(--forge-dialog-position-y, 0);
    }
  }

  :host([placement=top]) {
    .surface {
      @include override(spacing, 0 auto, value);

      top: 0;
      bottom: auto;
    }
  }

  :host([placement=top-right]) {
    .surface {
      @include override(spacing, 0, value);

      top: 0;
      left: auto;
      right: 0;
      bottom: auto;
    }
  }

  :host([placement=top-left]) {
    .surface {
      @include override(spacing, 0, value);

      top: 0;
      left: 0;
      right: auto;
      bottom: auto;
    }
  }

  :host([placement=bottom]) {
    .surface {
      @include override(spacing, 0 auto, value);

      top: auto;
      bottom: 0;
    }
  }

  :host([placement=bottom-right]) {
    .surface {
      @include override(spacing, 0, value);

      top: auto;
      left: auto;
      right: 0;
      bottom: 0;
    }
  }

  :host([placement=bottom-left]) {
    .surface {
      @include override(spacing, 0, value);

      top: auto;
      left: 0;
      right: auto;
      bottom: 0;
    }
  }

  :host([placement=left]) {
    .surface {
      @include override(spacing, auto 0, value);
      left: 0;
      right: auto;
    }
  }

  :host([placement=right]) {
    .surface {
      @include override(spacing, auto 0, value);
      left: auto;
      right: 0;
    }
  }
}

//
// Size strategy
//

@layer size-strategy {
  :host([size-strategy=container-inline]) {
    .surface {
      // @include override(max-width, none, value);

      width: 100%;
    }
  }

  :host([size-strategy=container-block]) {
    .surface {
      // @include override(max-height, none, value);

      height: 100%;
    }
  }
}

//
// Preset
//

@layer preset {
  :host(#{$can-animate}:is([preset=left-sheet],[preset=right-sheet],[preset=top-sheet],[preset=bottom-sheet])) {
    .forge-dialog {
      @include override(enter-animation-duration, 400ms, value);
      @include override(exit-animation-duration, 200ms, value);
    }

    .surface {
      animation-name: slide-in;

      &.exiting {
        animation-name: slide-out;
      }
    }
  }

  :host([preset=left-sheet]) {
    .forge-dialog {
      @include override(slide-translate, -100% 0, value);
    }

    .surface {
      @include override(max-width, none, value);
      @include override(max-height, none, value);

      inset: auto;
      left: 0;
      bottom: 0;
      top: 0;
      height: 100%;
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
    }

  }

  :host([preset=right-sheet]) {
    .forge-dialog {
      @include override(slide-translate, 100% 0, value);
    }

    .surface {
      @include override(max-width, none, value);
      @include override(max-height, none, value);

      inset: auto;
      right: 0;
      bottom: 0;
      top: 0;
      height: 100%;
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
    }
  }

  :host([preset=top-sheet]) {
    .forge-dialog {
      @include override(slide-translate, 0 -100%, value);
    }

    .surface {
      @include override(max-width, none, value);
      @include override(max-height, none, value);

      inset: auto;
      top: 0;
      left: 0;
      right: 0;
      border-top-left-radius: 0;
      border-top-right-radius: 0;
    }
  }

  :host([preset=bottom-sheet]) {
    .forge-dialog {
      @include override(slide-translate, 0 100%, value);
    }

    .surface {
      @include override(max-width, none, value);
      @include override(max-height, none, value);

      inset: auto;
      bottom: 0;
      left: 0;
      right: 0;
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
    }
  }
}

//
// Full screen
//

@layer fullscreen {
  :host([fullscreen]) {
    .forge-dialog {
      @include override(enter-animation-duration, 400ms, value);
      @include override(exit-animation-duration, 200ms, value);
    }

    .surface {
      height: 100%;
      width: 100%;
      max-width: none;
      max-height: none;
      border-radius: 0;
      box-shadow: none;
    }

    forge-backdrop {
      display: none;
    }
  }
}

//
// Position strategy
//

@layer position-strategy {
  :host([position-strategy=viewport]) {
    .forge-dialog {
      position: fixed;
    }
  }

  :host([position-strategy=container]) {
    .forge-dialog {
      position: absolute;
    }
  }
}

//
// Media
//

@layer media {
  @media (prefers-reduced-motion: reduce) {
    .surface {
      animation-name: fade-in;

      &.exiting {
        animation-name: fade-out;
      }
    }
  }
}
